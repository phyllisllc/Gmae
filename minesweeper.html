<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>æ‰«é›· - Trae æ¸¸æˆå¤§å…</title>
    <style>
        /* å…¨å±€å˜é‡ */
        :root {
            --primary-color: #6366f1;
            --primary-light: #818cf8;
            --secondary-color: #10b981;
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --success-color: #10b981;
        }
        
        /* å…¨å±€æ ·å¼é‡ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* èƒŒæ™¯ç½‘æ ¼æ•ˆæœ - Traeé£æ ¼ */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                linear-gradient(rgba(99, 102, 241, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(99, 102, 241, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            z-index: -1;
        }
        
        /* ä¸»å®¹å™¨ */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 24px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* é¡¶éƒ¨å¯¼èˆªæ  - Traeé£æ ¼ */
        .header {
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            background-color: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(8px);
            z-index: 100;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logo {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .back-link {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .back-link:hover {
            color: var(--text-primary);
            background-color: var(--bg-secondary);
        }
        
        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            flex: 1;
            padding: 40px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* é¡µé¢æ ‡é¢˜ */
        .page-header {
            margin-bottom: 32px;
            text-align: center;
        }
        
        .page-title {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
            line-height: 1.2;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        
        .game-icon-large {
            font-size: 40px;
        }
        
        /* æ¸¸æˆå®¹å™¨ */
        .game-container {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 16px var(--shadow-color);
            width: 100%;
            max-width: 600px;
        }
        
        /* æ¸¸æˆæ§åˆ¶åŒºåŸŸ */
        .game-controls {
            margin-bottom: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        /* éš¾åº¦é€‰æ‹© */
        .difficulty-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .difficulty-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .difficulty-btn {
            padding: 10px 20px;
            border: 1px solid var(--border-color);
            background-color: transparent;
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            min-width: 80px;
        }
        
        .difficulty-btn:hover {
            border-color: var(--primary-light);
            color: var(--text-primary);
        }
        
        .difficulty-btn.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }
        
        /* æ¸¸æˆä¿¡æ¯é¢æ¿ */
        .game-info-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background-color: var(--bg-primary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 24px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        
        .info-value {
            font-size: 20px;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            color: var(--primary-color);
        }
        
        .info-label {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* é‡ç½®æŒ‰é’® */
        .reset-btn {
            padding: 12px 24px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .reset-btn:hover {
            background-color: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        .reset-btn:active {
            transform: translateY(0);
        }
        
        /* æ¸¸æˆæ£‹ç›˜ */
        .game-board {
            display: grid;
            gap: 2px;
            background-color: var(--border-color);
            padding: 4px;
            border-radius: 8px;
            overflow: hidden;
            margin: 0 auto;
        }
        
        /* æ¸¸æˆæ ¼å­ */
        .cell {
            aspect-ratio: auto; /* ç§»é™¤å›ºå®šçš„aspect-ratioï¼Œä½¿ç”¨æ˜ç¡®çš„widthå’Œheight */
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.1s ease;
            font-size: 14px;
            user-select: none;
            touch-action: manipulation;
            box-sizing: border-box; /* ç¡®ä¿borderä¸å½±å“å®é™…å°ºå¯¸ */
        }
        
        /* çˆ†ç‚¸åŠ¨ç”» */
        @keyframes explode {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* æ——å­æ ‡è®°åŠ¨ç”» */
        @keyframes flagShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }
        
        /* ç¡®ä¿æ•°å­—æ˜¾ç¤ºæ¸…æ™° */
        .cell.revealed.number-1, 
        .cell.revealed.number-2, 
        .cell.revealed.number-3, 
        .cell.revealed.number-4, 
        .cell.revealed.number-5, 
        .cell.revealed.number-6, 
        .cell.revealed.number-7, 
        .cell.revealed.number-8 {
            font-size: 16px;
            font-weight: bold;
        }
        
        .cell:hover:not(.revealed):not(.flagged) {
            background-color: var(--bg-secondary);
        }
        
        .cell.revealed {
            background-color: var(--bg-secondary);
            cursor: default;
        }
        
        .cell.flagged {
            background-color: var(--warning-color);
            color: white;
        }
        
        .cell.mine-exploded {
            background-color: var(--danger-color);
            color: white;
        }
        
        .cell.mine {
            background-color: var(--bg-primary);
        }
        
        /* æ•°å­—é¢œè‰² */
        .cell.revealed.number-1 { color: #3b82f6; }
        .cell.revealed.number-2 { color: #10b981; }
        .cell.revealed.number-3 { color: #ef4444; }
        .cell.revealed.number-4 { color: #8b5cf6; }
        .cell.revealed.number-5 { color: #f97316; }
        .cell.revealed.number-6 { color: #ec4899; }
        .cell.revealed.number-7 { color: #14b8a6; }
        .cell.revealed.number-8 { color: #6b7280; }
        
        /* æ¸¸æˆç»“æŸè¦†ç›–å±‚ */
        .game-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(15, 23, 42, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
            display: none;
        }
        
        .game-overlay.show {
            display: flex;
        }
        
        .overlay-content {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 32px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 32px var(--shadow-color);
        }
        
        .overlay-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-primary);
        }
        
        .overlay-message {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 24px;
            line-height: 1.5;
        }
        
        .overlay-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        /* æ“ä½œæç¤º */
        .instructions {
            margin-top: 24px;
            padding: 16px;
            background-color: rgba(99, 102, 241, 0.05);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .instruction-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }
        
        .instruction-list {
            list-style: none;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .instruction-item {
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .instruction-icon {
            font-size: 16px;
            color: var(--primary-light);
            min-width: 20px;
            text-align: center;
        }
        
        /* æ•°å­—é¢œè‰²æ ·å¼ */
        .cell.number-1 { color: #0000ff; } /* è“è‰² */
        .cell.number-2 { color: #008000; } /* ç»¿è‰² */
        .cell.number-3 { color: #ff0000; } /* çº¢è‰² */
        .cell.number-4 { color: #800080; } /* ç´«è‰² */
        .cell.number-5 { color: #800000; } /* æ·±çº¢è‰² */
        .cell.number-6 { color: #008080; } /* é’è‰² */
        .cell.number-7 { color: #000000; } /* é»‘è‰² */
        .cell.number-8 { color: #808080; } /* ç°è‰² */
        
        /* åœ°é›·æ ·å¼å¢å¼º */
        .cell.mine {
            background-color: #ff6b6b;
        }
        
        .cell.mine-exploded {
            background-color: #ff0000;
            animation: explode 0.5s ease-out;
        }
        
        .cell.flag-error {
            position: relative;
        }
        
        .cell.flag-error::after {
            content: 'âŒ';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2em;
            color: #ffffff;
        }
        
        @keyframes explode {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.8;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                padding: 0 16px;
            }
            
            .main-content {
                padding: 24px 0;
            }
            
            .page-title {
                font-size: 24px;
            }
            
            .game-container {
                padding: 20px;
            }
            
            .difficulty-buttons {
                justify-content: center;
            }
        }
        
        /* å¾®ä¿¡å°ç¨‹åºåŠç§»åŠ¨è®¾å¤‡ä¼˜åŒ– */
        @media (max-width: 480px) {
            body {
                width: 100vw;
                height: 100vh;
                margin: 0;
                padding: 0;
                overflow-x: hidden;
                box-sizing: border-box;
                -webkit-text-size-adjust: 100%;
                -webkit-overflow-scrolling: touch;
                overflow-scrolling: touch;
            }
            
            .container {
                width: 100vw;
                padding: 0 15px;
                box-sizing: border-box;
            }
            
            .header {
                height: 56px;
            }
            
            .page-title {
                font-size: 22px;
                margin-bottom: 20px;
                padding-top: 10px;
            }
            
            .game-container {
                padding: 16px;
            }
            
            .game-board {
                gap: 1px;
                padding: 2px;
            }
            
            .cell {
                font-size: 12px;
                border-radius: 3px;
            }
            
            .difficulty-btn {
                padding: 8px 16px;
                font-size: 13px;
                min-width: 70px;
            }
            
            .info-value {
                font-size: 18px;
            }
            
            .reset-btn {
                padding: 10px 20px;
                font-size: 14px;
            }
        }
        
        /* é’ˆå¯¹ä¸åŒè®¾å¤‡é«˜åº¦çš„ä¼˜åŒ– */
        @media (max-height: 600px) and (max-width: 480px) {
            .main-content {
                padding: 16px 0;
            }
            
            .game-container {
                padding: 12px;
            }
            
            .game-controls {
                margin-bottom: 16px;
                gap: 12px;
            }
            
            .cell {
                font-size: 10px;
            }
        }
        
        /* æ¨ªå±æ¨¡å¼ä¼˜åŒ– */
        @media (orientation: landscape) and (max-width: 900px) {
            .game-container {
                padding: 16px;
            }
            
            .game-board {
                gap: 1px;
                padding: 2px;
            }
            
            .cell {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <header class="header">
            <a href="index.html" class="back-link">
                &larr; è¿”å›
            </a>
            <div class="logo-container">
                <div class="logo">æ‰«é›·</div>
            </div>
            <div style="width: 60px;"></div> <!-- å ä½ -->
        </header>
        
        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <!-- é¡µé¢æ ‡é¢˜ -->
            <div class="page-header">
                <h1 class="page-title">
                    <span class="game-icon-large">ğŸ’£</span>
                    æ‰«é›·æ¸¸æˆ
                </h1>
            </div>
            
            <!-- æ¸¸æˆå®¹å™¨ -->
            <div class="game-container">
                <!-- æ¸¸æˆæ§åˆ¶åŒºåŸŸ -->
                <div class="game-controls">
                    <!-- éš¾åº¦é€‰æ‹© -->
                    <div class="difficulty-section">
                        <h3 class="section-title">éš¾åº¦è®¾ç½®</h3>
                        <div class="difficulty-buttons">
                            <button class="difficulty-btn active" data-difficulty="beginner">åˆçº§</button>
                            <button class="difficulty-btn" data-difficulty="intermediate">ä¸­çº§</button>
                            <button class="difficulty-btn" data-difficulty="expert">é«˜çº§</button>
                        </div>
                    </div>
                    
                    <!-- æ¸¸æˆä¿¡æ¯é¢æ¿ -->
                    <div class="game-info-panel">
                        <div class="info-item">
                            <div class="info-value" id="mine-counter">0</div>
                            <div class="info-label">åœ°é›·æ•°</div>
                        </div>
                        <button class="reset-btn" id="reset-button">å¼€å§‹æ¸¸æˆ</button>
                        <div class="info-item">
                            <div class="info-value" id="timer">0</div>
                            <div class="info-label">æ—¶é—´</div>
                        </div>
                    </div>
                </div>
                
                <!-- æ¸¸æˆæ£‹ç›˜ -->
                <div class="game-board" id="game-board"></div>
            </div>
            
            <!-- æ“ä½œæç¤º -->
        <div class="instructions">
            <h3 class="instruction-title">æ‰«é›·ç©æ³•è¯´æ˜</h3>
            <p class="instruction-item" style="font-weight: normal;">ç»å…¸æ‰«é›·æ¸¸æˆï¼Œé”»ç‚¼é€»è¾‘æ€ç»´èƒ½åŠ›ï¼</p>
            <ul class="instruction-list">
                <li class="instruction-item">
                    <span class="instruction-icon">ğŸ‘†</span>
                    <span>ç‚¹å‡»æ ¼å­æ­ç¤ºå†…å®¹</span>
                </li>
                <li class="instruction-item">
                    <span class="instruction-icon">ğŸ‘‡</span>
                    <span>é•¿æŒ‰æ ¼å­æ ‡è®°å¯ç–‘çš„åœ°é›·ä½ç½®ï¼ˆğŸš©ï¼‰</span>
                </li>
                <li class="instruction-item">
                    <span class="instruction-icon">ğŸ”¢</span>
                    <span>æ ¼å­ä¸­çš„æ•°å­—è¡¨ç¤ºå…¶å‘¨å›´8ä¸ªæ ¼å­ä¸­éšè—çš„åœ°é›·æ•°é‡</span>
                </li>
                <li class="instruction-item">
                    <span class="instruction-icon">âšª</span>
                    <span>ç©ºç™½æ ¼å­ï¼ˆæ•°å­—0ï¼‰ä¼šè‡ªåŠ¨æ­ç¤ºå‘¨å›´çš„æ ¼å­</span>
                </li>
                <li class="instruction-item">
                    <span class="instruction-icon">âœ…</span>
                    <span>æˆåŠŸæ¡ä»¶ï¼šæ­ç¤ºæ‰€æœ‰éåœ°é›·æ ¼å­ï¼Œæˆ–æ­£ç¡®æ ‡è®°æ‰€æœ‰åœ°é›·ä½ç½®</span>
                </li>
                <li class="instruction-item">
                    <span class="instruction-icon">ğŸ’¥</span>
                    <span>å¤±è´¥æ¡ä»¶ï¼šç‚¹å‡»åˆ°åœ°é›·</span>
                </li>
                <li class="instruction-item">
                    <span class="instruction-icon">ğŸšï¸</span>
                    <span>éš¾åº¦é€‰æ‹©ï¼šåˆçº§(9Ã—9ï¼Œ10ä¸ªåœ°é›·)ã€ä¸­çº§(16Ã—16ï¼Œ40ä¸ªåœ°é›·)ã€é«˜çº§(16Ã—30ï¼Œ99ä¸ªåœ°é›·)</span>
                </li>
            </ul>
            <p class="instruction-item" style="font-weight: bold; margin-top: 8px;">
                <span class="instruction-icon">ğŸ’¡</span>
                <span>æç¤ºï¼šä½¿ç”¨æ•°å­—é€»è¾‘æ¨ç†ï¼Œå…ˆä»è¾¹ç¼˜æ ¼å­å¼€å§‹ç‚¹å‡»å¯ä»¥æ›´å®‰å…¨åœ°å¼€å§‹æ¸¸æˆ</span>
            </p>
        </div>
        </main>
    </div>
    
    <!-- æ¸¸æˆç»“æŸè¦†ç›–å±‚ -->
    <div class="game-overlay" id="game-overlay">
        <div class="overlay-content">
            <h2 class="overlay-title" id="overlay-title">æ¸¸æˆç»“æŸ</h2>
            <p class="overlay-message" id="overlay-message">å†æ¥å†å‰ï¼</p>
            <div class="overlay-buttons">
                <button class="reset-btn" id="overlay-reset">å†æ¥ä¸€å±€</button>
                <button class="reset-btn" id="overlay-change-difficulty">æ›´æ¢éš¾åº¦</button>
            </div>
        </div>
    </div>
    
    <script>
        // æ¸¸æˆé…ç½®
        const DIFFICULTY_SETTINGS = {
            beginner: { rows: 9, cols: 9, mines: 10 },
            intermediate: { rows: 16, cols: 16, mines: 40 },
            expert: { rows: 16, cols: 30, mines: 99 }
        };
        
        // æ¸¸æˆçŠ¶æ€å˜é‡
        let gameState = {
            difficulty: 'beginner',
            board: [],
            revealed: [],
            flagged: [],
            mines: [],
            gameStarted: false,
            gameOver: false,
            gameWon: false,
            timer: null,
            time: 0,
            firstClick: true,
            cellSize: 32
        };
        
        // DOMå…ƒç´ 
        const gameBoard = document.getElementById('game-board');
        const mineCounter = document.getElementById('mine-counter');
        const timerElement = document.getElementById('timer');
        const resetButton = document.getElementById('reset-button');
        const difficultyButtons = document.querySelectorAll('.difficulty-btn');
        const gameOverlay = document.getElementById('game-overlay');
        const overlayTitle = document.getElementById('overlay-title');
        const overlayMessage = document.getElementById('overlay-message');
        const overlayReset = document.getElementById('overlay-reset');
        const overlayChangeDifficulty = document.getElementById('overlay-change-difficulty');
        
        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            const settings = DIFFICULTY_SETTINGS[gameState.difficulty];
            const { rows, cols, mines } = settings;
            
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameState.board = createEmptyBoard(rows, cols);
            gameState.revealed = createEmptyBoard(rows, cols, false);
            gameState.flagged = createEmptyBoard(rows, cols, false);
            gameState.mines = [];
            gameState.gameStarted = false;
            gameState.gameOver = false;
            gameState.gameWon = false;
            gameState.time = 0;
            gameState.firstClick = true;
            
            // é‡ç½®è®¡æ—¶å™¨
            if (gameState.timer) {
                clearInterval(gameState.timer);
            }
            timerElement.textContent = '0';
            
            // æ›´æ–°åœ°é›·è®¡æ•°å™¨
            mineCounter.textContent = mines.toString().padStart(3, '0');
            
            // åˆ›å»ºæ¸¸æˆæ£‹ç›˜
            createGameBoard(rows, cols);
            
            // éšè—æ¸¸æˆç»“æŸè¦†ç›–å±‚
            gameOverlay.classList.remove('show');
            
            // è°ƒæ•´æ¸¸æˆå¤§å°
            adjustGameSize();
        }
        
        // åˆ›å»ºç©ºæ£‹ç›˜
        function createEmptyBoard(rows, cols, defaultValue = 0) {
            return Array(rows).fill().map(() => Array(cols).fill(defaultValue));
        }
        
        // åˆ›å»ºæ¸¸æˆæ£‹ç›˜DOM
        function createGameBoard(rows, cols) {
            gameBoard.innerHTML = '';
            gameBoard.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
            gameBoard.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    cell.addEventListener('click', () => handleCellClick(row, col));
                    
                    // æ·»åŠ è§¦æ‘¸äº‹ä»¶ï¼ˆç‚¹å‡»å’Œé•¿æŒ‰ï¼‰
                    let longPressTimer;
                    let touchStartTime;
                    let touchStartX;
                    let touchStartY;
                    let touchMoved = false;
                    let isLongPressDetected = false;
                    
                    cell.addEventListener('touchstart', (e) => {
                        // é˜²æ­¢é»˜è®¤è¡Œä¸ºï¼Œä½†ä¸é˜»æ­¢æ»šåŠ¨
                        e.preventDefault();
                        
                        // é‡ç½®çŠ¶æ€
                        isLongPressDetected = false;
                        touchMoved = false;
                        
                        // è®°å½•è§¦æ‘¸å¼€å§‹æ—¶é—´å’Œä½ç½®
                        touchStartTime = Date.now();
                        touchStartX = e.touches[0].clientX;
                        touchStartY = e.touches[0].clientY;
                        
                        // æ·»åŠ è§†è§‰åé¦ˆ
                        cell.style.transform = 'scale(0.95)';
                        
                        // è®¾ç½®é•¿æŒ‰è®¡æ—¶å™¨ï¼Œæ”¹ä¸º600msæ›´æ˜æ˜¾
                        longPressTimer = setTimeout(() => {
                            isLongPressDetected = true;
                            handleCellLongPress(row, col);
                            // ä¸ºé•¿æŒ‰æ·»åŠ ç‰¹æ®Šè§†è§‰åé¦ˆ
                            cell.style.transform = 'scale(0.9)';
                        }, 600);
                    });
                    
                    cell.addEventListener('touchend', (e) => {
                        clearTimeout(longPressTimer);
                        
                        // åªæœ‰åœ¨æ²¡æœ‰ç§»åŠ¨å¤ªå¤šä¸”ä¸æ˜¯é•¿æŒ‰çš„æƒ…å†µä¸‹æ‰å¤„ç†ç‚¹å‡»
                        if (!touchMoved && !isLongPressDetected) {
                            // è®¡ç®—è§¦æ‘¸æŒç»­æ—¶é—´
                            const touchDuration = Date.now() - touchStartTime;
                            
                            // çŸ­æ—¶é—´è§¦æ‘¸è§†ä¸ºç‚¹å‡»
                            if (touchDuration < 300) {
                                handleCellClick(row, col);
                            }
                        }
                        
                        // ç§»é™¤è§†è§‰åé¦ˆï¼ˆå»¶è¿Ÿä¸€ç‚¹ä»¥ç¡®ä¿åŠ¨ç”»æ•ˆæœï¼‰
                        setTimeout(() => {
                            cell.style.transform = '';
                        }, 50);
                    });
                    
                    cell.addEventListener('touchmove', (e) => {
                        // åªåœ¨é•¿æŒ‰æœªæ£€æµ‹åˆ°æ—¶æ¸…é™¤è®¡æ—¶å™¨
                        if (!isLongPressDetected) {
                            clearTimeout(longPressTimer);
                        }
                        
                        // è®¡ç®—ç§»åŠ¨è·ç¦»
                        const touchCurrentX = e.touches[0].clientX;
                        const touchCurrentY = e.touches[0].clientY;
                        const touchDistance = Math.sqrt(
                            Math.pow(touchCurrentX - touchStartX, 2) + 
                            Math.pow(touchCurrentY - touchStartY, 2)
                        );
                        
                        // å¦‚æœç§»åŠ¨è·ç¦»è¶…è¿‡é˜ˆå€¼ï¼Œæ ‡è®°ä¸ºå·²ç§»åŠ¨
                        if (touchDistance > 10) {
                            touchMoved = true;
                            // åªåœ¨é•¿æŒ‰æœªæ£€æµ‹åˆ°æ—¶ç§»é™¤è§†è§‰åé¦ˆ
                            if (!isLongPressDetected) {
                                cell.style.transform = '';
                            }
                        }
                    });
                    
                    cell.addEventListener('touchcancel', () => {
                        clearTimeout(longPressTimer);
                        isLongPressDetected = false;
                        setTimeout(() => {
                            cell.style.transform = '';
                        }, 50);
                    });
                    
                    // æ·»åŠ å³é”®èœå•äº‹ä»¶ï¼ˆPCç«¯æ ‡è®°åœ°é›·ï¼‰
                    cell.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        // ç¡®ä¿å³é”®ç‚¹å‡»ä¸ä¼šè§¦å‘å…¶ä»–äº‹ä»¶
                        e.stopPropagation();
                        handleCellRightClick(row, col);
                    });
                    
                    gameBoard.appendChild(cell);
                }
            }
        }
        
        // å¤„ç†æ ¼å­ç‚¹å‡»
        function handleCellClick(row, col) {
            if (gameState.gameOver || gameState.gameWon) return;
            if (gameState.revealed[row][col] || gameState.flagged[row][col]) return;
            
            // æ·»åŠ ç‚¹å‡»è§†è§‰åé¦ˆ
            const cellElement = getCellElement(row, col);
            if (cellElement) {
                cellElement.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    if (cellElement) cellElement.style.transform = '';
                }, 100);
            }
            
            // å¼€å§‹æ¸¸æˆ
            if (gameState.firstClick) {
                startGame(row, col);
                gameState.firstClick = false;
            }
            
            // ç‚¹å‡»åœ°é›·ï¼Œæ¸¸æˆç»“æŸ
            if (gameState.board[row][col] === 'M') {
                // å…ˆæ­ç¤ºæ‰€æœ‰åœ°é›·ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æ‰€æœ‰ç‚¸å¼¹ä½ç½®
                gameState.mines.forEach(({ row: mineRow, col: mineCol }) => {
                    revealCell(mineRow, mineCol);
                });
                
                // æ ‡è®°çˆ†ç‚¸çš„åœ°é›·
                if (cellElement) {
                    cellElement.classList.add('mine-exploded');
                    cellElement.style.backgroundColor = '#ff4444';
                    cellElement.style.animation = 'explode 0.3s ease';
                }
                
                // æ˜¾ç¤ºé”™è¯¯æ ‡è®°
                for (let r = 0; r < gameState.board.length; r++) {
                    for (let c = 0; c < gameState.board[r].length; c++) {
                        if (gameState.flagged[r][c] && gameState.board[r][c] !== 'M') {
                            const flagCell = getCellElement(r, c);
                            if (flagCell) {
                                flagCell.classList.remove('flagged');
                                flagCell.classList.add('revealed', 'flag-error');
                                flagCell.textContent = 'âŒ';
                                flagCell.style.backgroundColor = '#ffcccc';
                            }
                        }
                    }
                }
                
                gameState.gameOver = true;
                
                // åœæ­¢è®¡æ—¶å™¨
                if (gameState.timer) {
                    clearInterval(gameState.timer);
                }
                
                // æ˜¾ç¤ºæ¸¸æˆç»“æŸè¦†ç›–å±‚
                setTimeout(() => {
                    overlayTitle.textContent = 'æ¸¸æˆç»“æŸï¼';
                    overlayMessage.textContent = `å¾ˆé—æ†¾ï¼Œä½ è¸©åˆ°äº†åœ°é›·ï¼ç”¨æ—¶ ${gameState.time} ç§’ã€‚ç°åœ¨ä½ å¯ä»¥çœ‹åˆ°æ‰€æœ‰ç‚¸å¼¹çš„ä½ç½®äº†ã€‚`;
                    gameOverlay.classList.add('show');
                }, 500);
                
                return;
            }
            
            // æ­ç¤ºæ ¼å­
            revealCell(row, col);
            
            // æ£€æŸ¥æ˜¯å¦è·èƒœ
            checkWin();
        }
        
        // å¤„ç†æ ¼å­é•¿æŒ‰ï¼ˆç§»åŠ¨ç«¯æ ‡è®°åœ°é›·ï¼‰
        function handleCellLongPress(row, col) {
            if (gameState.gameOver || gameState.gameWon) return;
            if (gameState.revealed[row][col]) return;
            
            // å¼€å§‹æ¸¸æˆä½†ä¸è§¦å‘ç¬¬ä¸€æ¬¡ç‚¹å‡»
            if (gameState.firstClick) {
                startGame(row, col, true);
                gameState.firstClick = false;
            }
            
            // è§¦å‘æ ‡è®°å¹¶æ·»åŠ è§†è§‰åé¦ˆ
            const cellElement = getCellElement(row, col);
            if (cellElement) {
                // æ·»åŠ è½»å¾®çš„æŠ–åŠ¨åŠ¨ç”»è¡¨ç¤ºæ ‡è®°æ“ä½œ
                cellElement.style.animation = 'none';
                cellElement.offsetHeight; // è§¦å‘é‡ç»˜
                cellElement.style.animation = 'flagShake 0.3s ease';
            }
            
            toggleFlag(row, col);
        }
        
        // å¤„ç†æ ¼å­å³é”®ç‚¹å‡»ï¼ˆPCç«¯æ ‡è®°åœ°é›·ï¼‰
        function handleCellRightClick(row, col) {
            if (gameState.gameOver || gameState.gameWon) return;
            if (gameState.revealed[row][col]) return;
            
            // å¼€å§‹æ¸¸æˆä½†ä¸è§¦å‘ç¬¬ä¸€æ¬¡ç‚¹å‡»
            if (gameState.firstClick) {
                startGame(row, col, true);
                gameState.firstClick = false;
            }
            
            // è§¦å‘æ ‡è®°å¹¶æ·»åŠ è§†è§‰åé¦ˆ
            const cellElement = getCellElement(row, col);
            if (cellElement) {
                // æ·»åŠ è½»å¾®çš„æŠ–åŠ¨åŠ¨ç”»è¡¨ç¤ºæ ‡è®°æ“ä½œ
                cellElement.style.animation = 'none';
                cellElement.offsetHeight; // è§¦å‘é‡ç»˜
                cellElement.style.animation = 'flagShake 0.3s ease';
            }
            
            toggleFlag(row, col);
        }
        
        // å¼€å§‹æ¸¸æˆ
        function startGame(firstRow, firstCol, isFlag = false) {
            const settings = DIFFICULTY_SETTINGS[gameState.difficulty];
            const { rows, cols, mines } = settings;
            
            // æ”¾ç½®åœ°é›·ï¼Œé¿å¼€é¦–æ¬¡ç‚¹å‡»ä½ç½®
            placeMines(rows, cols, mines, firstRow, firstCol);
            
            // è®¡ç®—æ•°å­—
            calculateNumbers(rows, cols);
            
            // å¼€å§‹è®¡æ—¶å™¨
            gameState.gameStarted = true;
            gameState.timer = setInterval(() => {
                gameState.time++;
                timerElement.textContent = gameState.time.toString().padStart(3, '0');
            }, 1000);
            
            // å¦‚æœä¸æ˜¯æ ‡è®°æ“ä½œï¼Œæ­ç¤ºç¬¬ä¸€ä¸ªæ ¼å­
            if (!isFlag) {
                revealCell(firstRow, firstCol);
            }
        }
        
        // æ”¾ç½®åœ°é›·
        function placeMines(rows, cols, minesCount, safeRow, safeCol) {
            let placedMines = 0;
            
            while (placedMines < minesCount) {
                const row = Math.floor(Math.random() * rows);
                const col = Math.floor(Math.random() * cols);
                
                // ç¡®ä¿ä¸ç ´åå®‰å…¨åŒºåŸŸï¼ˆé¦–æ¬¡ç‚¹å‡»ä½ç½®åŠå…¶å‘¨å›´8ä¸ªæ ¼å­ï¼‰
                const isInSafeZone = Math.abs(row - safeRow) <= 1 && Math.abs(col - safeCol) <= 1;
                
                if (!isInSafeZone && gameState.board[row][col] !== 'M') {
                    gameState.board[row][col] = 'M';
                    gameState.mines.push({ row, col });
                    placedMines++;
                }
            }
        }
        
        // è®¡ç®—æ•°å­—
        function calculateNumbers(rows, cols) {
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    if (gameState.board[row][col] === 'M') continue;
                    
                    let mineCount = 0;
                    for (let r = Math.max(0, row - 1); r <= Math.min(rows - 1, row + 1); r++) {
                        for (let c = Math.max(0, col - 1); c <= Math.min(cols - 1, col + 1); c++) {
                            if (r === row && c === col) continue;
                            if (gameState.board[r][c] === 'M') {
                                mineCount++;
                            }
                        }
                    }
                    
                    gameState.board[row][col] = mineCount;
                }
            }
        }
        
        // æ­ç¤ºæ ¼å­
        function revealCell(row, col) {
            const settings = DIFFICULTY_SETTINGS[gameState.difficulty];
            const { rows, cols } = settings;
            
            // è¾¹ç•Œæ£€æŸ¥
            if (row < 0 || row >= rows || col < 0 || col >= cols) return;
            if (gameState.revealed[row][col] || gameState.flagged[row][col]) return;
            
            // è·å–æ ¼å­å€¼
            const value = gameState.board[row][col];
            
            // æ ‡è®°ä¸ºå·²æ­ç¤º
            gameState.revealed[row][col] = true;
            
            // æ›´æ–°DOM
            const cellElement = getCellElement(row, col);
            if (cellElement) {
                cellElement.classList.add('revealed');
                
                // æ›´æ–°å•å…ƒæ ¼æ˜¾ç¤ºå†…å®¹
                if (value === 'M') {
                    // å¦‚æœæ˜¯åœ°é›·ï¼Œæ˜¾ç¤ºç‚¸å¼¹
                    cellElement.textContent = 'ğŸ’£';
                    cellElement.classList.add('mine');
                } else if (value > 0) {
                    // æ˜¾ç¤ºæ•°å­—
                    cellElement.textContent = value;
                    cellElement.classList.add(`number-${value}`);
                } else {
                    // æ•°å­—0çš„æ ¼å­ç•™ç©º
                    cellElement.textContent = '';
                }
            }
            
            // é€’å½’æ­ç¤ºç©ºç™½æ ¼å­å‘¨å›´çš„æ ¼å­
            if (value === 0) {
                for (let r = row - 1; r <= row + 1; r++) {
                    for (let c = col - 1; c <= col + 1; c++) {
                        if (r !== row || c !== col) {
                            revealCell(r, c);
                        }
                    }
                }
            }
        }
        
        // åˆ‡æ¢æ ‡è®°
        function toggleFlag(row, col) {
            const settings = DIFFICULTY_SETTINGS[gameState.difficulty];
            
            gameState.flagged[row][col] = !gameState.flagged[row][col];
            
            const cellElement = getCellElement(row, col);
            if (cellElement) {
                if (gameState.flagged[row][col]) {
                    cellElement.classList.add('flagged');
                    cellElement.textContent = 'ğŸš©';
                } else {
                    cellElement.classList.remove('flagged');
                    cellElement.textContent = '';
                }
            }
            
            // æ›´æ–°åœ°é›·è®¡æ•°å™¨
            const flaggedCount = gameState.flagged.flat().filter(f => f).length;
            const remainingMines = settings.mines - flaggedCount;
            mineCounter.textContent = remainingMines.toString().padStart(3, '0');
            
            // æ£€æŸ¥æ˜¯å¦è·èƒœï¼ˆæ‰€æœ‰åœ°é›·éƒ½è¢«æ ‡è®°ä¸”æ‰€æœ‰éåœ°é›·æ ¼å­éƒ½è¢«æ­ç¤ºï¼‰
            checkWin();
        }
        
        // æ¸¸æˆç»“æŸ
        function gameOver(explodedRow, explodedCol) {
            gameState.gameOver = true;
            
            // åœæ­¢è®¡æ—¶å™¨
            if (gameState.timer) {
                clearInterval(gameState.timer);
            }
            
            // æ˜¾ç¤ºæ‰€æœ‰åœ°é›·
            gameState.mines.forEach(({ row, col }) => {
                const cellElement = getCellElement(row, col);
                if (cellElement) {
                    cellElement.classList.add('revealed');
                    // ç§»é™¤æ ‡è®°çŠ¶æ€ï¼ˆå¦‚æœæœ‰ï¼‰å¹¶æ˜¾ç¤ºç‚¸å¼¹
                    cellElement.classList.remove('flagged');
                    cellElement.textContent = 'ğŸ’£';
                    
                    if (row === explodedRow && col === explodedCol) {
                        cellElement.classList.add('mine-exploded');
                        // ä¸ºçˆ†ç‚¸çš„åœ°é›·æ·»åŠ é¢å¤–çš„è§†è§‰æ•ˆæœ
                        cellElement.style.backgroundColor = '#ff4444';
                        cellElement.style.animation = 'explode 0.3s ease';
                    } else {
                        cellElement.classList.add('mine');
                        // ä¸ºæ™®é€šåœ°é›·æ·»åŠ èƒŒæ™¯è‰²
                        cellElement.style.backgroundColor = '#ff6666';
                    }
                }
            });
            
            // æ˜¾ç¤ºé”™è¯¯æ ‡è®°
            for (let row = 0; row < gameState.board.length; row++) {
                for (let col = 0; col < gameState.board[row].length; col++) {
                    if (gameState.flagged[row][col] && gameState.board[row][col] !== 'M') {
                        const cellElement = getCellElement(row, col);
                        if (cellElement) {
                            cellElement.classList.remove('flagged');
                            cellElement.classList.add('revealed', 'flag-error');
                            cellElement.textContent = 'âŒ';
                            // ä¸ºé”™è¯¯æ ‡è®°æ·»åŠ çº¢è‰²èƒŒæ™¯
                            cellElement.style.backgroundColor = '#ffcccc';
                        }
                    }
                }
            }
            
            // æ˜¾ç¤ºæ¸¸æˆç»“æŸè¦†ç›–å±‚
            overlayTitle.textContent = 'æ¸¸æˆç»“æŸï¼';
            overlayMessage.textContent = `å¾ˆé—æ†¾ï¼Œä½ è¸©åˆ°äº†åœ°é›·ï¼ç”¨æ—¶ ${gameState.time} ç§’ã€‚`;
            gameOverlay.classList.add('show');
        }
        
        // æ£€æŸ¥æ˜¯å¦è·èƒœ
        function checkWin() {
            const settings = DIFFICULTY_SETTINGS[gameState.difficulty];
            const { rows, cols, mines } = settings;
            
            // æ£€æŸ¥æ‰€æœ‰éåœ°é›·æ ¼å­æ˜¯å¦éƒ½å·²æ­ç¤º
            let revealedCount = 0;
            let totalNonMines = rows * cols - mines;
            
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    if (gameState.board[row][col] !== 'M' && gameState.revealed[row][col]) {
                        revealedCount++;
                    }
                }
            }
            
            // æ£€æŸ¥æ‰€æœ‰åœ°é›·æ˜¯å¦éƒ½è¢«æ­£ç¡®æ ‡è®°
            let allMinesFlagged = true;
            gameState.mines.forEach(({ row, col }) => {
                if (!gameState.flagged[row][col]) {
                    allMinesFlagged = false;
                }
            });
            
            // æ£€æŸ¥æ˜¯å¦æ²¡æœ‰é”™è¯¯æ ‡è®°
            let noWrongFlags = true;
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    if (gameState.flagged[row][col] && gameState.board[row][col] !== 'M') {
                        noWrongFlags = false;
                    }
                }
            }
            
            // ä¸¤ç§è·èƒœæ¡ä»¶ï¼š
            // 1. æ‰€æœ‰éåœ°é›·æ ¼å­éƒ½è¢«æ­ç¤º
            // 2. æ‰€æœ‰åœ°é›·éƒ½è¢«æ­£ç¡®æ ‡è®°ä¸”æ²¡æœ‰é”™è¯¯æ ‡è®°
            if ((revealedCount === totalNonMines && gameState.gameStarted) || 
                (allMinesFlagged && noWrongFlags && gameState.gameStarted)) {
                gameState.gameWon = true;
                
                // åœæ­¢è®¡æ—¶å™¨
                if (gameState.timer) {
                    clearInterval(gameState.timer);
                }
                
                // è‡ªåŠ¨æ ‡è®°å‰©ä½™çš„åœ°é›·
                gameState.mines.forEach(({ row, col }) => {
                    if (!gameState.flagged[row][col]) {
                        gameState.flagged[row][col] = true;
                        const cellElement = getCellElement(row, col);
                        if (cellElement) {
                            cellElement.classList.add('flagged');
                            cellElement.textContent = 'ğŸš©';
                        }
                    }
                });
                
                // æ˜¾ç¤ºè·èƒœè¦†ç›–å±‚
                overlayTitle.textContent = 'æ­å–œè·èƒœï¼';
                overlayMessage.textContent = `ä½ æˆåŠŸæ’é™¤äº†æ‰€æœ‰åœ°é›·ï¼ç”¨æ—¶ ${gameState.time} ç§’ã€‚`;
                gameOverlay.classList.add('show');
            }
        }
        
        // è·å–æ ¼å­å…ƒç´ 
        function getCellElement(row, col) {
            return document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
        }
        
        // è°ƒæ•´æ¸¸æˆå¤§å°
        function adjustGameSize() {
            const settings = DIFFICULTY_SETTINGS[gameState.difficulty];
            const { rows, cols } = settings;
            
            // è·å–æ¸¸æˆæ¿å®¹å™¨çš„å®é™…å¯ç”¨ç©ºé—´
            const containerElement = gameBoard.parentElement;
            const containerWidth = containerElement.clientWidth - 32; // å‡å»paddingå’Œmargin
            const containerHeight = containerElement.clientHeight - 32;
            
            // è€ƒè™‘ç½‘æ ¼é—´è·ï¼ˆgapä¸º2pxï¼‰
            const gap = 2;
            const gridPadding = 4;
            
            // åŸºäºå®½åº¦å’Œé«˜åº¦è®¡ç®—æœ€å¤§æ ¼å­å¤§å°
            const widthBasedSize = (containerWidth - 2 * gridPadding - (cols - 1) * gap) / cols;
            const heightBasedSize = (containerHeight - 2 * gridPadding - (rows - 1) * gap) / rows;
            
            // å–è¾ƒå°å€¼å¹¶é™åˆ¶æœ€å¤§å¤§å°
            const cellSize = Math.floor(Math.min(widthBasedSize, heightBasedSize, 40)); // æœ€å¤§40px
            gameState.cellSize = cellSize;
            
            // é‡æ–°è®¡ç®—å¹¶è®¾ç½®æ¸¸æˆæ¿å°ºå¯¸ï¼Œç¡®ä¿åŒ…å«æ‰€æœ‰æ ¼å­å’Œé—´è·
            gameBoard.style.width = `${2 * gridPadding + cols * cellSize + (cols - 1) * gap}px`;
            gameBoard.style.height = `${2 * gridPadding + rows * cellSize + (rows - 1) * gap}px`;
            
            // ç¡®ä¿æ¸¸æˆæ¿å±…ä¸­
            gameBoard.style.margin = '0 auto';
            
            // è®¾ç½®æ ¼å­å¤§å°
            const cells = document.querySelectorAll('.cell');
            cells.forEach(cell => {
                // ç§»é™¤aspect-ratioä»¥é¿å…å°ºå¯¸å†²çª
                cell.style.aspectRatio = 'auto';
                cell.style.width = `${cellSize}px`;
                cell.style.height = `${cellSize}px`;
                cell.style.position = 'relative';
                cell.style.zIndex = '10';
                cell.style.cursor = 'pointer';
                cell.style.transition = 'transform 0.1s ease';
                cell.style.userSelect = 'none';
                cell.style.display = 'flex';
                cell.style.alignItems = 'center';
                cell.style.justifyContent = 'center';
                
                // æ ¹æ®æ ¼å­å¤§å°è°ƒæ•´å­—ä½“å¤§å°
                if (cellSize < 24) {
                    cell.style.fontSize = '10px';
                } else if (cellSize < 30) {
                    cell.style.fontSize = '12px';
                } else {
                    cell.style.fontSize = '14px';
                }
            });
        }
        
        // å¾®ä¿¡ç¯å¢ƒæ£€æµ‹
        function isWechatEnvironment() {
            return /MicroMessenger\/([\d\.]+)/.test(navigator.userAgent);
        }
        
        // åŠ¨æ€è°ƒæ•´æ¸¸æˆå°ºå¯¸ä»¥é€‚åº”å¾®ä¿¡ç¯å¢ƒ
        function adjustGameSizeForWechat() {
            if (isWechatEnvironment()) {
                // è·å–å®é™…è§†çª—å°ºå¯¸
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                
                // è®¡ç®—å¯ç”¨é«˜åº¦ï¼ˆå‡å»æ ‡é¢˜æ å’Œæ§åˆ¶åŒºåŸŸï¼‰
                const headerHeight = document.querySelector('.header').offsetHeight;
                const gameControlsHeight = document.querySelector('.game-controls').offsetHeight;
                const instructionsHeight = document.querySelector('.instructions')?.offsetHeight || 0;
                
                const availableHeight = viewportHeight - headerHeight - gameControlsHeight - instructionsHeight - 80; // é¢å¤–å‡å»ä¸€äº›padding
                
                // è°ƒæ•´æ¸¸æˆæ¿å¤§å°
                const settings = DIFFICULTY_SETTINGS[gameState.difficulty];
                const { rows, cols } = settings;
                
                // è€ƒè™‘ç½‘æ ¼é—´è·
                const gap = 2;
                const gridPadding = 4;
                
                // åŸºäºå¯ç”¨å®½åº¦å’Œé«˜åº¦è®¡ç®—æœ€ä½³æ ¼å­å¤§å°
                const widthBasedSize = (viewportWidth - 40 - 2 * gridPadding - (cols - 1) * gap) / cols; // è€ƒè™‘paddingã€é—´è·
                const heightBasedSize = (availableHeight - 2 * gridPadding - (rows - 1) * gap) / rows;
                
                const optimalSize = Math.floor(Math.min(widthBasedSize, heightBasedSize, 35)); // æœ€å¤§35px
                
                // è®¾ç½®æ¸¸æˆæ¿å°ºå¯¸
                gameBoard.style.width = `${2 * gridPadding + cols * optimalSize + (cols - 1) * gap}px`;
                gameBoard.style.height = `${2 * gridPadding + rows * optimalSize + (rows - 1) * gap}px`;
                gameBoard.style.margin = '0 auto';
                
                // è®¾ç½®æ ¼å­å¤§å°
                const cells = document.querySelectorAll('.cell');
                cells.forEach(cell => {
                    // ç§»é™¤aspect-ratioä»¥é¿å…å°ºå¯¸å†²çª
                    cell.style.aspectRatio = 'auto';
                    cell.style.width = `${optimalSize}px`;
                    cell.style.height = `${optimalSize}px`;
                    cell.style.transition = 'transform 0.1s ease';
                    cell.style.userSelect = 'none';
                    cell.style.display = 'flex';
                    cell.style.alignItems = 'center';
                    cell.style.justifyContent = 'center';
                    
                    // æ ¹æ®æ ¼å­å¤§å°è°ƒæ•´å­—ä½“å¤§å°
                    if (optimalSize < 24) {
                        cell.style.fontSize = '10px';
                    } else if (optimalSize < 30) {
                        cell.style.fontSize = '12px';
                    } else {
                        cell.style.fontSize = '14px';
                    }
                });
                
                // ç¡®ä¿æ¸¸æˆæ¿å±…ä¸­å¹¶æ›´æ–°å…¶å°ºå¯¸
                gameBoard.style.width = `${cols * optimalSize}px`;
                gameBoard.style.height = `${rows * optimalSize}px`;
                gameBoard.style.maxWidth = '100%';
                gameBoard.style.maxHeight = `${availableHeight}px`;
                gameBoard.style.margin = '0 auto'; // ç¡®ä¿å±…ä¸­æ˜¾ç¤º
            }
        }
        
        // äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // éš¾åº¦é€‰æ‹©æŒ‰é’®
            difficultyButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
                    difficultyButtons.forEach(btn => btn.classList.remove('active'));
                    
                    // æ·»åŠ å½“å‰æŒ‰é’®æ¿€æ´»çŠ¶æ€
                    button.classList.add('active');
                    
                    // æ›´æ–°éš¾åº¦
                    gameState.difficulty = button.dataset.difficulty;
                    
                    // é‡æ–°åˆå§‹åŒ–æ¸¸æˆ
                    initGame();
                });
            });
            
            // é‡ç½®æŒ‰é’®
            resetButton.addEventListener('click', initGame);
            
            // è¦†ç›–å±‚æŒ‰é’®
            overlayReset.addEventListener('click', () => {
                gameOverlay.classList.remove('show');
                initGame();
            });
            
            overlayChangeDifficulty.addEventListener('click', () => {
                gameOverlay.classList.remove('show');
                // æ»šåŠ¨åˆ°éš¾åº¦é€‰æ‹©åŒºåŸŸ
                document.querySelector('.difficulty-section').scrollIntoView({ behavior: 'smooth' });
            });
            
            // çª—å£å¤§å°å˜åŒ–æ—¶è°ƒæ•´æ¸¸æˆå¤§å°
            window.addEventListener('resize', () => {
                adjustGameSize();
                if (isWechatEnvironment()) {
                    adjustGameSizeForWechat();
                }
            });
            
            // æ–¹å‘å˜åŒ–æ—¶è°ƒæ•´æ¸¸æˆå¤§å°ï¼ˆç§»åŠ¨ç«¯ï¼‰
            window.addEventListener('orientationchange', () => {
                setTimeout(() => {
                    adjustGameSize();
                    if (isWechatEnvironment()) {
                        adjustGameSizeForWechat();
                    }
                }, 300);
            });
            
            // é¡µé¢å¯è§æ€§å˜åŒ–
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    // é¡µé¢ä¸å¯è§æ—¶æš‚åœè®¡æ—¶å™¨
                    if (gameState.gameStarted && !gameState.gameOver && !gameState.gameWon && gameState.timer) {
                        clearInterval(gameState.timer);
                        gameState.timer = null;
                    }
                } else {
                    // é¡µé¢å¯è§æ—¶æ¢å¤è®¡æ—¶å™¨
                    if (gameState.gameStarted && !gameState.gameOver && !gameState.gameWon && !gameState.timer) {
                        gameState.timer = setInterval(() => {
                            gameState.time++;
                            timerElement.textContent = gameState.time.toString().padStart(3, '0');
                        }, 1000);
                    }
                }
            });
            
            // ç¦ç”¨å¾®ä¿¡é»˜è®¤çš„åŒå‡»ç¼©æ”¾
            document.addEventListener('dblclick', (e) => {
                e.preventDefault();
            });
            
            // ä¼˜åŒ–è§¦æ‘¸æ»šåŠ¨
            document.body.style.touchAction = 'manipulation';
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // ç¡®ä¿DOMå…ƒç´ å·²åŠ è½½
            if (!gameBoard || !resetButton || !mineCounter || !timerElement) {
                console.error('æ¸¸æˆDOMå…ƒç´ æœªæ­£ç¡®åŠ è½½');
                return;
            }
            
            setupEventListeners();
            initGame();
            
            // ä¿®å¤è§¦æ‘¸äº‹ä»¶å¤„ç†
            document.body.style.touchAction = 'auto';
            
            // æ£€æŸ¥æ˜¯å¦åœ¨å¾®ä¿¡ç¯å¢ƒä¸­
            if (isWechatEnvironment()) {
                console.log('åœ¨å¾®ä¿¡ç¯å¢ƒä¸­è¿è¡Œï¼Œå¯ç”¨å¾®ä¿¡é€‚é…æ¨¡å¼');
                
                // æ›´æ–°è§†å£è®¾ç½®
                const viewport = document.querySelector('meta[name=viewport]');
                if (viewport) {
                    viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover');
                }
            }
            
            // ç¡®ä¿æ¸¸æˆæ¿æœ‰æ­£ç¡®çš„å±‚çº§å’Œäº¤äº’å±æ€§
            gameBoard.style.position = 'relative';
            gameBoard.style.zIndex = '5';
            gameBoard.style.pointerEvents = 'auto';
            
            // å¼ºåˆ¶è°ƒæ•´æ¸¸æˆå¤§å°
            setTimeout(() => {
                adjustGameSize();
                if (isWechatEnvironment()) {
                    adjustGameSizeForWechat();
                }
            }, 200);
        });
        
        // ç¡®ä¿çª—å£åŠ è½½å®Œæˆåå†æ¬¡åˆå§‹åŒ–
        window.addEventListener('load', () => {
            setTimeout(() => {
                // é‡æ–°åº”ç”¨äº‹ä»¶ç›‘å¬å™¨åˆ°æ‰€æœ‰æ ¼å­
                const cells = document.querySelectorAll('.cell');
                cells.forEach(cell => {
                    const row = parseInt(cell.dataset.row);
                    const col = parseInt(cell.dataset.col);
                    
                    // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„äº‹ä»¶ç›‘å¬å™¨
                    const newCell = cell.cloneNode(true);
                    cell.parentNode.replaceChild(newCell, cell);
                    
                    // é‡æ–°æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                    newCell.addEventListener('click', () => handleCellClick(row, col));
                    
                    let longPressTimer;
                    let touchStartTime;
                    let touchStartX;
                    let touchStartY;
                    
                    newCell.addEventListener('touchstart', (e) => {
                        touchStartTime = Date.now();
                        touchStartX = e.touches[0].clientX;
                        touchStartY = e.touches[0].clientY;
                        longPressTimer = setTimeout(() => handleCellLongPress(row, col), 500);
                    });
                    
                    newCell.addEventListener('touchend', (e) => {
                        clearTimeout(longPressTimer);
                        const touchDuration = Date.now() - touchStartTime;
                        const touchEndX = e.changedTouches[0].clientX;
                        const touchEndY = e.changedTouches[0].clientY;
                        const touchDistance = Math.sqrt(
                            Math.pow(touchEndX - touchStartX, 2) + 
                            Math.pow(touchEndY - touchStartY, 2)
                        );
                        
                        if (touchDuration < 300 && touchDistance < 10) {
                            handleCellClick(row, col);
                        }
                    });
                    
                    newCell.addEventListener('touchmove', () => {
                        clearTimeout(longPressTimer);
                    });
                    
                    newCell.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        handleCellRightClick(row, col);
                    });
                });
                
                adjustGameSize();
            }, 500);
        });
    </script>
</body>
</html>